name: Cleanup Old Docker Images
description: Remove old Docker images except current and backup versions

inputs:
  ssh_host:
    description: SSH host address
    required: true
  ssh_user:
    description: SSH username
    required: true
  ssh_key:
    description: SSH private key
    required: true
  ssh_port:
    description: SSH port
    required: false
    default: '22'
  version_file:
    description: Path to DEPLOYED_VERSION file
    required: true
  image_pattern:
    description: Pattern to match images for cleanup (e.g., "infra-monitoring", "proflyder-tgbot")
    required: true

runs:
  using: composite
  steps:
    - name: Cleanup old images
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ inputs.ssh_host }}
        username: ${{ inputs.ssh_user }}
        key: ${{ inputs.ssh_key }}
        port: ${{ inputs.ssh_port }}
        timeout: 2m
        script: |
          echo 'ðŸ§¹ Cleaning up old Docker images...'

          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ dangling Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (Ð±ÐµÐ· Ñ‚ÐµÐ³Ð¾Ð²)
          sudo docker image prune -f

          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (ÐºÑ€Ð¾Ð¼Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¸ backup)
          CURRENT_IMAGE=$(grep "^Image:" ${{ inputs.version_file }} | awk '{print $2}')
          BACKUP_IMAGE=$(grep "^Image:" ${{ inputs.version_file }}.backup 2>/dev/null | awk '{print $2}' || echo "none")

          echo "Current image: $CURRENT_IMAGE"
          echo "Backup image: $BACKUP_IMAGE"
          echo ''

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¿Ð¾ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñƒ
          OLD_IMAGES=$(sudo docker images --format "{{.Repository}}:{{.Tag}}" | grep "${{ inputs.image_pattern }}" | grep -v "$CURRENT_IMAGE" | grep -v "$BACKUP_IMAGE" | grep -v "latest" || true)

          for image in $OLD_IMAGES; do
            echo "Removing old image: $image"
            sudo docker rmi "$image" 2>/dev/null || true
          done

          echo 'âœ… Cleanup completed!'
